تقرير وخطة عمل لمشروع COPRRA - مهمة إصلاح وتحسين جودة الكود (الإصدار 2.0)
إلى: Manus Agent
من: gasseraly
الموضوع: استكمال مهمة إصلاح سير عمل CI/CD، ورفع تغطية الاختبارات إلى 100% بشكل مرحلي.
1.0 الملخص التنفيذي والهدف الأساسي (Primary Goal)
الهدف الأساسي: إصلاح جميع الأخطاء الحالية في سير عمل CI/CD على GitHub Actions للوصول إلى حالة نجاح كاملة (علامة خضراء ✅)، ثم البدء في خطة مرحلية لرفع نسبة تغطية الاختبارات في SonarQube إلى 100%.
الوضع الحالي: سير العمل يفشل حاليًا بسبب مجموعة من أخطاء PDOException (تحديدًا Column not found) التي تحدث أثناء تشغيل اختبارات PHPUnit.
2.0 سياق المشروع وتاريخ المشكلة (Project Context)
لقد مر المشروع بسلسلة من مراحل تصحيح الأخطاء التي كشفت عن المشاكل التالية بالترتيب:
خطأ 500 غامض.
خطأ علاقات (Null Pointer).
خطأ ربط المسار بالنموذج (Route Model Binding).
خطأ بناء الجملة (Parse Error).
خطأ التعيين الجماعي (MassAssignmentException).
المشكلة الحالية - عدم تطابق بنية قاعدة البيانات (Schema Mismatch): الـ Factories تحاول إنشاء بيانات لحقول غير موجودة في جداول قاعدة البيانات الفعلية التي يتم إنشاؤها في بيئة CI/CD.
3.0 الخطة الأساسية للتنفيذ (Core Execution Plan)
يجب على الإيجنت اتباع هذه الخطة بشكل منهجي.
3.1 المرحلة الأولى: تحقيق الاستقرار (الوصول إلى العلامة الخضراء)
هذه هي المرحلة الأكثر أهمية لحل جميع الأخطاء الحالية.
التحليل: الخطأ PDOException: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'description' in 'field list' يعني أن ProductFactory يحاول تعبئة حقل description غير موجود في جدول products.
الإجراء: مزامنة الـ Factories والـ Models مع بنية قاعدة البيانات الفعلية والمؤكدة. الاستراتيجية المعتمدة هي تبسيط الـ Factories والـ Models مؤقتًا لتمرير الاختبارات.
تعديل database/factories/ProductFactory.php: قم بإزالة جميع الحقول غير الأساسية (slug, description, price, is_active, etc.).
تعديل app/Models/Product.php: قم بتحديث خاصية $fillable لتتطابق مع الـ Factory المبسط.
تكرار العملية: قم بنفس التبسيط لـ ReviewFactory و Review Model وأي موديلات أخرى تسبب أخطاء مشابهة.
دورة الاختبار والإصلاح:
قم بتشغيل ./vendor/bin/phpunit محليًا.
حلل أي أخطاء جديدة وقم بإصلاحها.
قم بتشغيل ./vendor/bin/pint للتأكد من جودة الكود.
الرفع والمراقبة:
نفذ دورة git add ., git commit, git pull, git push.
راقب سير عمل CI/CD.
كرر العملية حتى تصل إلى علامة النجاح الخضراء ✅.
3.2 المرحلة الثانية: خطة رفع تغطية الاختبارات إلى 100% (خطة مرحلية)
الهدف من هذه المرحلة: رفع نسبة تغطية الاختبارات بشكل تدريجي ومنظم، مع إنشاء نقاط حفظ (ملفات مضغوطة) بعد كل إنجاز.
نقطة الانطلاق: بعد تحقيق العلامة الخضراء في المرحلة الأولى، قم بتحليل تقرير SonarQube لتحديد نسبة التغطية الحالية (لنفترض أنها X%).
المرحلة 2.1: الوصول إلى تغطية 40%
التحليل: حدد الملفات ذات أقل نسبة تغطية (مثل PriceSearchController, WishlistController).
الإجراء: قم بكتابة وتنفيذ مجموعات اختبارات جديدة (Feature و Unit) لهذه الملفات.
التحقق: قم بتشغيل دورة الاختبار والإصلاح والرفع (كما في المرحلة 3.1) حتى تنجح جميع الاختبارات وتظهر نسبة التغطية في SonarQube 40% أو أعلى.
نقطة الحفظ (Checkpoint): بمجرد تحقيق الهدف، قم بإنشاء ملف مضغوط جديد للمشروع بالكامل باسم coprra-project-coverage-40.zip.
المرحلة 2.2: الوصول إلى تغطية 50%
التحليل: انطلاقًا من الحالة الحالية، حدد مجموعة جديدة من الملفات غير المغطاة (مثل LocaleMiddleware, CartController).
الإجراء: قم بكتابة وتنفيذ اختبارات جديدة لهذه المكونات.
التحقق: قم بتشغيل دورة الاختبار والإصلاح والرفع حتى تنجح جميع الاختبارات وتظهر نسبة التغطية في SonarQube 50% أو أعلى.
نقطة الحفظ (Checkpoint): قم بإنشاء ملف مضغوط جديد للمشروع بالكامل باسم coprra-project-coverage-50.zip.
تكرار العملية: استمر في تكرار هذه الدورة بزيادات 10% (أو حسب ما تراه مناسبًا) مع إنشاء ملف مضغوط جديد في كل مرة (...coverage-60.zip, ...coverage-70.zip, إلخ) حتى تصل إلى الهدف النهائي.
الهدف النهائي: الوصول إلى نسبة تغطية 100% وإنشاء الملف النهائي coprra-project-coverage-100.zip.
4.0 الأدوات والموارد (Tools & Resources)
أدوات CI/CD: GitHub Actions, SonarQube.
أدوات الاختبار: PHPUnit.
أداة فحص الكود: Laravel Pint.
الموارد المتاحة: سيتم تزويدك بملف مضغوط يحتوي على الحالة الحالية الكاملة للمشروع كنقطة انطلاق.
الخلاصة: المهمة واضحة ومقسمة إلى مراحل. ابدأ بـ المرحلة 3.1 لتحقيق الاستقرار والعلامة الخضراء، ثم انتقل إلى المرحلة 3.2 لتنفيذ خطة رفع التغطية المرحلية. أنا في انتظار تقاريرك المرحلية وملفاتك المضغوطة.